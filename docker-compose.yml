version: '3'
services:
    odfe-node1:
        image: amazon/opendistro-for-elasticsearch:1.11.0
        container_name: odfe-node1
        environment:
            - opendistro_security.disabled=true
            - cluster.name=odfe-cluster
            - node.name=odfe-node1
            - discovery.seed_hosts=odfe-node1
            - cluster.initial_master_nodes=odfe-node1
            - bootstrap.memory_lock=true # along with the memlock settings below, disables swapping
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # minimum and maximum Java heap size, recommend setting both to 50% of system RAM
            - network.host=0.0.0.0 # allows us to access from the host machine
        ulimits:
            memlock:
                soft: -1
                hard: -1
            nofile:
                soft: 65536 # maximum number of open files for the Elasticsearch user, set to at least 65536 on modern systems
                hard: 65536
        volumes:
            - ./.docker/data/data1:/usr/share/elasticsearch/data
        ports:
            - 9201:9200
            - 9601:9600 # required for Performance Analyzer
        networks:
            - odfe-net
    kibana:
        image: amazon/opendistro-for-elasticsearch-kibana:1.11.0
        container_name: odfe-kibana
        ports:
            - 5602:5601
        expose:
            - "5601"
        environment:
            ELASTICSEARCH_URL: http://odfe-node1:9200
            ELASTICSEARCH_HOSTS: http://odfe-node1:9200
        networks:
            - odfe-net
    api-dummy:
        image: elifesciences/api-dummy:29d80e7726a513afb2362068de55a9bab7aad0ae
        container_name: api-dummy
        ports:
            - 5002:8080
        networks:
            - odfe-net
    gearman:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - 4730:4730
    gearmanui:
        image: koryonik/gearman-ui
        container_name: gearmanui
        ports:
            - "8085:80"
        links:
            - gearman
    goaws:
        image: pafortin/goaws
        container_name: goaws
        volumes:
            - ./.docker/goaws.yaml:/conf/goaws.yaml
        ports:
            - 4100:4100
        networks:
            - odfe-net
networks:
    odfe-net:
