#!/usr/bin/env bash
environment=$1

if [ -z "$environment" ]; then
    echo "environment needs to be passed as first argument";
    exit 2;
fi;

# propagate SIGINT to waiting process
trap 'kill -INT -$waitingPid' INT

./bin/console queue:clean --env="$environment"
# TODO: poll for queue:count == 0, with timeout
sleep 5

echo "Starting a gearman:worker"
./bin/console gearman:worker --env="$environment" 2>&1 | tee /tmp/gearman-worker.log &
workerPid=$!
echo "Starting a queue:watch"
./bin/console queue:watch --env="$environment" 2>&1 | tee /tmp/queue-watch.log &
queueWatchPid=$!
echo "Starting import"
./bin/console gearman:import all --env="$environment"

# will return also on failing conditions such as dead processes
timeout 60 ./bin/wait-for-empty-gearman-queue "$environment" &
waitingPid=$!
wait "$waitingPid"
# clean up PHP processes
kill "$workerPid" "$queueWatchPid";

# final verification
# we start from an empty index
total=$(curl -v localhost/search | jq ".total")
echo "Total results in the index: $total"
minimum=28
if [ ! "$total" -ge "$minimum" ]; then
    echo "There should be at least $minimum result in the index"
    exit 2
fi

