#!/usr/bin/env bash
set -e
. bin/ci-process-bootstrap

./bin/console keyvalue:setup --env="$environment"
./bin/console keyvalue:store index-metadata '{"write":"elife_search", "read":"elife_search"}' --env="$environment"
./bin/console search:setup --index="elife_search" --delete --env="$environment"

./bin/console queue:clean --env="$environment"
# TODO: poll for queue:count == 0, with timeout
sleep 5

. bin/ci-start-processes

echo "Starting import"
./bin/console queue:import all --env="$environment"
echo "Finished launching import"

. bin/ci-wait-steady-state
. bin/ci-expected-results
