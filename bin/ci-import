#!/usr/bin/env bash
. bin/ci-process-bootstrap

./bin/console queue:clean --env="$environment"
# TODO: poll for queue:count == 0, with timeout
sleep 5

. bin/ci-start-processes

echo "Starting import"
./bin/console queue:import all --env="$environment"
echo "Finished launching import"

. bin/ci-wait-steady-state

# final verification
# we start from an empty index
total=$(curl -v localhost/search | jq ".total")
echo "Total results in the index: $total"
expected_results_api_dummy=22
if [ ! "$total" -eq "$expected_results_api_dummy" ]; then
    echo "There should be at least $expected_results_api_dummy results in the index"
    exit 2
fi

