#!/usr/bin/env bash
environment=$1

if [ -z "$environment" ]; then
    echo "environment needs to be passed as first argument";
    exit 2;
fi;

./bin/console queue:clean --env=$environment
# TODO: poll for queue:count == 0, with timeout
sleep 5

echo "Starting a gearman:worker"
./bin/console gearman:worker --env=$environment | tee /tmp/gearman-worker.log &
workerPid=$!
echo "Starting a queue:watch"
./bin/console queue:watch --env=$environment | tee /tmp/queue-watch.log &
queueWatchPid=$!
echo "Starting import"
./bin/console gearman:import all --env=$environment

timeout 60 ./bin/wait-for-empty-gearman-queue

kill $workerPid $queueWatchPid;
