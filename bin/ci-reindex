#!/usr/bin/env bash
. bin/ci-process-bootstrap

./bin/console queue:clean --env="$environment"
# TODO: poll for queue:count == 0, with timeout
sleep 5

index_name=elife_search_$(date +%Y%m%d%H%M%S)
./bin/console search:setup --index="$index_name" --delete

./bin/console index:switch:write "$index_name"
. bin/ci-start-processes

echo "Starting reindexing"
./bin/console queue:import all --env="$environment"
echo "Finished launching reindexing"

. bin/ci-wait-steady-state
echo '{"write":"'$index_name'", "read":"'$index_name'"}' > index.json
. bin/ci-expected-results
