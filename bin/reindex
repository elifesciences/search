#!/usr/bin/env bash
set -e

if [ "$#" -gt 1 ]; then
    echo "Usage: bin/reindex INDEX_NAME"
    echo "Example: bin/reindex elife_search_67"
    exit 1
fi

index_name="$1"

sudo start search-gearman-workers-stop-all

echo "Starting a gearman:worker"
./bin/console gearman:worker --env="$environment" --index="$index_name" >> /tmp/gearman-worker.log 2>&1 &
workerPid=$!
echo "gearman:worker PID $workerPid"

./bin/console queue:import all --env="$environment"

# 4. wait for empty SQS and Gearman queues
# 5. switch index
# 6. smoke test it
