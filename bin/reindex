#!/usr/bin/env bash
set -e

if [ "$#" -gt 2 ]; then
    echo "Usage: bin/reindex ENVIRONMENT INDEX_NAME"
    echo "Example: bin/reindex end2end elife_search_67"
    exit 1
fi

environment="$1"
index_name="$2"

sudo start search-gearman-worker-stop-all

echo "Starting a gearman:worker"
./bin/console gearman:worker --env="$environment" --index="$index_name" >> /tmp/gearman-worker.log 2>&1 &
workerPid=$!
echo "gearman:worker PID $workerPid"

./bin/console queue:import all --env="$environment"

./bin/wait-for-empty-queues "$environment"

# 5. switch index
# 6. smoke test it
