version: '3'
services:

    opensearch:
        build:
            context: .
            dockerfile: Dockerfile.opensearch

        environment:
            - cluster.name=opensearch-cluster
            - node.name=opensearch
            - discovery.type=single-node
            - DISABLE_SECURITY_PLUGIN=true
            - bootstrap.memory_lock=true # along with the memlock settings below, disables swapping
        ulimits:
            memlock:
                soft: -1
                hard: -1
            nofile:
                soft: 65536 # maximum number of open files for the OpenSearch user, set to at least 65536 on modern systems
                hard: 65536
        volumes:
            - opensearch-data1:/usr/share/opensearch/data
        ports:
            - '9200:9200'
            - '9600:9600' # required for Performance Analyzer
        healthcheck:
            test: ["CMD-SHELL", "curl --silent --fail localhost:9200/_cluster/health || exit 1"]
            interval: 2s
            timeout: 2s
            retries: 10

    api-dummy:
        image: elifesciences/api-dummy:c66acdb349850d31b4e7a0f578ffdc87e2fada96
        container_name: api-dummy
        ports:
            - '5002:8080'

    gearman:
        image: artefactual/gearmand:latest
        container_name: gearman
        healthcheck:
            test: ["CMD-SHELL", "gearadmin --status"]
            interval: 2s
            timeout: 2s
            retries: 3

    localstack:
        image: localstack/localstack:2.3.2
        environment:
            - SERVICES=sqs
            - AWS_DEFAULT_REGION=eu-central-1
            - EDGE_PORT=4566
            - HOSTNAME_EXTERNAL=localstack
        ports:
            - '4566:4566'

    setup:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - GEARMAN_HOST=gearman
        command:
        - /bin/bash
        - "-c"
        - |
            composer install
            php bin/console queue:create;
            php bin/console search:setup;
            php bin/console keyvalue:setup
        volumes:
            - ./:/app
            - ./config.php:/app/config.php
        depends_on:
            opensearch:
                condition: service_healthy
            gearman:
                condition: service_healthy
            localstack:
                condition: service_healthy

    app:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - GEARMAN_HOST=gearman
        volumes:
            - ./:/app
            - ./config.php:/app/config.php
        ports:
            - '8888:80'
        depends_on:
            setup:
                condition: service_completed_successfully
        stdin_open: true
        tty: true

    gearman-worker:
        build:
            context: .
            dockerfile: Dockerfile
        command: bin/console gearman:worker
        environment:
            - GEARMAN_HOST=gearman
        volumes:
            - ./:/app
            - ./config.php:/app/config.php
        depends_on:
            setup:
                condition: service_completed_successfully

    queue-watcher:
        build:
            context: .
            dockerfile: Dockerfile
        command: bin/console queue:watch
        environment:
            - GEARMAN_HOST=gearman
        volumes:
            - ./:/app
            - ./config.php:/app/config.php
        depends_on:
            setup:
                condition: service_completed_successfully


volumes:
    opensearch-data1:
